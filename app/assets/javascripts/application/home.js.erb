$(document).ready(function() {
    "use strict";
    var loading= false,
        reachedEnd= false;

    $(document).on('click', '.activity-feed .load-more', function () {
        var _this        = $(this),
            activityFeed = $('.activity-feed .activities');
        _this.text('<%= I18n.t('activities.ui.loading'); %>');
        loading= true;
        $.ajax("/activities.html", {
                    data: {
                        'from_time': activityFeed.find('.activity:last time').attr('datetime')
                    },
                    cache: false,
                    success: function (d, s, xhr) {
                        if (xhr.status == 200 || xhr.status == 304) {
                            activityFeed.append(d);
                            _this.text('<%= I18n.t('activities.ui.load_more') %>');
                        } else if (xhr.status == 204) {
                            _this.text('<%= I18n.t('activities.ui.no_more_artivities') %>');
                            reachedEnd = true;
                            window.setTimeout(function() {
                                reachedEnd = false;
                            }, 30*1000);
                        }
                        loading = false;
                    }
                }
        );

    });

    $(window).scroll(function() {
        if (!loading && !reachedEnd && ($(window).scrollTop() >  $(document).height() - $(window).height() - 300)) {
            $('.activity-feed .load-more').click();
        }
    });
});