Argu.activityFeed = {
    loading: false,
    reachedEnd: false,
    init: function () {
        $(document).on('click', '.activity-feed .load-more', this.loadMore);

        $(window).scroll(function() {
            if (!Argu.activityFeed.loading && !Argu.activityFeed.reachedEnd && ($(window).scrollTop() >  $(document).height() - $(window).height() - 300)) {
                $('.activity-feed .load-more').click();
            }
        });
    },

    loadMore: function () {
        var _this   = $(this),
            feedDOM = $('.activity-feed .activities');
        _this.text('<%= I18n.t('activities.ui.loading'); %>');
        Argu.activityFeed.loading= true;
        $.ajax("/activities.html", {
            data: {
                'from_time': feedDOM.find('.activity:last time').attr('datetime')
            },
            cache: false,
            success: function (d, s, xhr) {
                if (xhr.status == 200 || xhr.status == 304) {
                    feedDOM.append(d);
                    _this.text('<%= I18n.t('activities.ui.load_more') %>');
                } else if (xhr.status == 204) {
                    _this.text('<%= I18n.t('activities.ui.no_more_artivities') %>');
                    Argu.activityFeed.reachedEnd = true;
                    window.setTimeout(function() {
                        Argu.activityFeed.reachedEnd = false;
                    }, 30*1000);
                }
                Argu.activityFeed.loading = false;
            }
        });
    }
};