/*global React, $*/

window.NewMembership = React.createClass({
    getInitialState: function () {
        return {
            display_name: this.props.display_name,
            image: this.props.image
        };
    },

    componentDidMount: function () {
        var _this = this;
        var addBlock = $(this.getDOMNode());
        var input = $(this.getDOMNode()).find('.select-input');
        input.selectize({
            valueField: 'id',
            searchField: ['shortname', 'name'],
            persist: false,
            create: false,
            onItemAdd: function (value) {
                addBlock.find('.profile-photo').attr('src', addBlock.find('[data-id="' + value + '"]').attr('data-src'));
            },
            onDelete: function () {
                addBlock.find('.profile-photo').attr('src', '/profile_photos/original/missing.png');
            },
            render: {
                option: function(item, escape) {
                    return '<div class="search-result" data-id="' + escape(item.id) + '" data-src="' + escape(item.profile_photo.icon.url) + '"><span><img class="profile-xs" src="' + escape(item.profile_photo.icon.url) + '"></span><span class="label">' + escape(item.name) + '</span></div>';
                },
                item: function(data, escape) {
                    return '<div data-value="' + escape(data.id) + '" class="item">' + escape(data.name) + ' (' + escape(data.shortname) + ')</div>';
                }
            },
            load: function(query, callback) {
                if (!query.length) return callback();
                $.ajax({
                    url: '/profiles.json',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        q: query,
                        thing: _this.props.thing,
                        things: _this.props.things
                    },
                    error: function () {
                        callback();
                    },
                    success: function (res) {
                        console.log(res.profiles.length);
                        callback(res.profiles);
                    }
                });
            }
        });
    },

    render: function () {

        return (<li className="template">
            <img src="/profile_photos/original/missing.png"  className="profile-photo" />
            <select name="profile_id" className="select-input"></select>
        </li>);
    }
});

if (typeof module !== 'undefined' && module.exports) {
    module.exports = NewMembership;
}
